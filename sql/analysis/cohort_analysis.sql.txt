USE ecommerce_project;

WITH first_purchase AS (
    SELECT 
        customer_id,
        MIN(DATE_FORMAT(order_date, '%Y-%m')) AS cohort_month
    FROM orders
    GROUP BY customer_id
),
monthly_orders AS (
    SELECT 
        customer_id,
        DATE_FORMAT(order_date, '%Y-%m') AS order_month
    FROM orders
)
SELECT 
    f.cohort_month,
    mo.order_month,
    COUNT(mo.customer_id) AS active_customers
FROM first_purchase f
JOIN monthly_orders mo USING(customer_id)
GROUP BY cohort_month, order_month
ORDER BY cohort_month, order_month;
